# Implementation Plan: Full-Stack Web Application

**Branch**: `002-fullstack-web-app` | **Date**: 2026-01-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-fullstack-web-app/spec.md`

**Note**: This template is filled in by the `/sp.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Transform the existing CLI in-memory Todo application into a multi-user, authenticated, full-stack web application with persistent storage. The system will support user registration, JWT-based authentication, full CRUD operations on tasks, and strict data isolation between users. The application will be containerized using Docker and deployable with a single `docker-compose up` command.

## Technical Context

**Language/Version**: Python 3.13+ (backend), TypeScript/JavaScript with Node.js 20+ (frontend)
**Primary Dependencies**: FastAPI (backend framework), SQLModel (ORM), Better Auth (authentication), Next.js 16+ (frontend framework)
**Storage**: Neon Serverless PostgreSQL (cloud-hosted, managed)
**Testing**: pytest (backend), Jest/React Testing Library (frontend)
**Target Platform**: Cross-platform web application (Docker containers)
**Project Type**: Web application (frontend + backend split)
**Performance Goals**: Task operations < 2s response time, application startup < 30s, 1000+ concurrent users supported
**Constraints**: All API endpoints must be authenticated, 100% user data isolation enforcement, no hardcoded secrets
**Scale/Scope**: Multi-user system with horizontal scalability, estimated 100-10k users for MVP phase

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Compliance Status: PASSED

All requirements align with Project Constitution v2.0.0:

| Constitution Requirement | Implementation Plan | Status |
|-------------------------|---------------------|--------|
| **3.1 Spec-Driven Development** | All phases follow Spec → Plan → Tasks → Implementation | ✅ PASS |
| **3.2 No Manual Coding** | All code generated by Claude Code via agentic workflow | ✅ PASS |
| **3.3 Monorepo Requirement** | Frontend and backend in single repository | ✅ PASS |
| **3.4 Security First** | All API endpoints authenticated, user-scoped queries | ✅ PASS |
| **5. Technology Stack** | Next.js 16+ App Router, FastAPI, SQLModel, Better Auth, Neon PostgreSQL, Docker | ✅ PASS |
| **6. REST API Contract** | All 6 endpoints specified (GET/POST/PUT/DELETE/PATCH tasks) | ✅ PASS |
| **7. Authentication** | Better Auth (frontend) + JWT verification (backend) | ✅ PASS |
| **8. Backend Rules** | SQLModel exclusive, user ID filtering, JWT middleware | ✅ PASS |
| **9. Frontend Rules** | App Router, responsive UI, JWT attachment | ✅ PASS |
| **10. Database Rules** | Neon PostgreSQL cloud-only, no local containers | ✅ PASS |
| **11. Docker Constitution** | Dockerfile for frontend/backend, docker-compose.yml | ✅ PASS |
| **12. Repository Structure** | Matches mandated structure exactly | ✅ PASS |

### Key Constraints Enforced

1. **Authentication Enforcement**: JWT middleware on backend verifies all requests
2. **Data Isolation**: All task queries filtered by authenticated user_id
3. **Secrets Management**: Environment variables only via .env files
4. **Deployment**: Single command startup via docker-compose
5. **No Substitutions**: Technology stack is fixed per constitution

### Gates Status

- **Phase 0 Gate**: ✅ PASSED - Constitution compliance verified
- **Phase 1 Gate**: Pending - Will re-check after design artifacts generated

## Project Structure

### Documentation (this feature)

```text
specs/002-fullstack-web-app/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
│   └── api-spec.yaml    # OpenAPI specification for REST endpoints
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── models/
│   │   ├── __init__.py
│   │   ├── user.py           # SQLModel User model
│   │   └── task.py           # SQLModel Task model
│   ├── services/
│   │   ├── __init__.py
│   │   ├── auth_service.py   # JWT verification logic
│   │   └── task_service.py   # Task business logic
│   ├── api/
│   │   ├── __init__.py
│   │   ├── routes/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py       # Auth endpoints (register, login)
│   │   │   └── tasks.py      # Task CRUD endpoints
│   │   └── dependencies.py   # FastAPI dependencies (auth, db)
│   ├── middleware/
│   │   ├── __init__.py
│   │   └── auth_middleware.py # JWT verification middleware
│   ├── database.py           # Database connection setup
│   ├── config.py             # Environment variable loading
│   └── main.py               # FastAPI app entry point
├── tests/
│   ├── __init__.py
│   ├── test_auth.py
│   ├── test_tasks.py
│   └── conftest.py           # pytest fixtures
├── requirements.txt          # Python dependencies
├── pyproject.toml            # Project metadata
├── pytest.ini                # pytest configuration
└── Dockerfile                # Backend container definition

frontend/
├── src/
│   ├── app/
│   │   ├── layout.tsx        # Root layout
│   │   ├── page.tsx          # Landing page
│   │   ├── (auth)/
│   │   │   ├── login/
│   │   │   │   └── page.tsx  # Login page
│   │   │   └── register/
│   │   │       └── page.tsx  # Registration page
│   │   └── (dashboard)/
│   │       └── tasks/
│   │           └── page.tsx  # Task dashboard
│   ├── components/
│   │   ├── TaskList.tsx      # Task list component
│   │   ├── TaskForm.tsx      # Task creation/edit form
│   │   └── TaskItem.tsx      # Individual task component
│   ├── services/
│   │   ├── api.ts            # API client with JWT attachment
│   │   └── tasks.ts          # Task API calls
│   ├── auth/
│   │   └── better-auth.config.ts # Better Auth configuration
│   ├── types/
│   │   └── index.ts          # TypeScript types
│   └── lib/
│       └── utils.ts          # Utility functions
├── public/
│   └── ...                   # Static assets
├── package.json              # Node dependencies
├── tsconfig.json             # TypeScript configuration
├── next.config.js            # Next.js configuration
├── tailwind.config.js        # Tailwind CSS configuration
└── Dockerfile                # Frontend container definition

# Root level
docker-compose.yml            # Service orchestration
.env.example                  # Environment variables template
README.md                     # Project overview
```

**Structure Decision**: Selected "Option 2: Web application" structure as this is explicitly a frontend + backend full-stack application per constitution section 12. The structure follows the mandated repository layout exactly.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. All requirements comply with Project Constitution v2.0.0.

## Phase 0: Research & Discovery

### Research Tasks

The following research tasks will be executed to resolve any remaining technical unknowns:

1. **Better Auth Integration Patterns**
   - Research: How Better Auth issues JWT tokens in Next.js 16 App Router
   - Research: Better Auth configuration best practices
   - Research: Session management and token refresh strategies
   - Output: Concrete implementation approach for authentication flow

2. **FastAPI + SQLModel Best Practices**
   - Research: SQLModel patterns for Neon PostgreSQL connection
   - Research: FastAPI middleware patterns for JWT verification
   - Research: Async database session management with SQLModel
   - Output: Database connection architecture and middleware design

3. **JWT Verification on Backend**
   - Research: Python libraries for JWT verification (PyJWT, python-jose)
   - Research: Shared secret management between Better Auth and FastAPI
   - Research: Token expiration handling and error responses
   - Output: JWT middleware implementation approach

4. **Docker Compose Networking**
   - Research: Service-to-service communication in Docker Compose
   - Research: Environment variable injection in multi-container setup
   - Research: Health checks and startup dependencies
   - Output: docker-compose.yml structure and networking configuration

5. **Next.js 16 App Router + Better Auth**
   - Research: Server components vs client components with authentication
   - Research: Protected route patterns in App Router
   - Research: API client setup with automatic JWT attachment
   - Output: Frontend architecture and routing strategy

### Research Output Location

All research findings will be consolidated in `/specs/002-fullstack-web-app/research.md`

## Phase 1: Design Artifacts

### 1. Data Model (`data-model.md`)

Define the complete database schema including:

- **User Entity**: email (unique), password_hash, created_at, updated_at
- **Task Entity**: id (UUID), user_id (FK), title, description, is_completed, created_at, updated_at
- **Relationships**: User (1) → (Many) Tasks
- **Constraints**: Foreign keys, unique constraints, NOT NULL requirements
- **Indexes**: User email, Task user_id + created_at

### 2. API Contracts (`contracts/api-spec.yaml`)

Generate OpenAPI 3.0 specification for all endpoints:

**Authentication Endpoints**:
- `POST /api/auth/register` - User registration
- `POST /api/auth/login` - User login (returns JWT)

**Task Endpoints** (all require authentication):
- `GET /api/tasks` - List user's tasks
- `POST /api/tasks` - Create new task
- `GET /api/tasks/{task_id}` - Get task details
- `PUT /api/tasks/{task_id}` - Update task
- `DELETE /api/tasks/{task_id}` - Delete task
- `PATCH /api/tasks/{task_id}/complete` - Toggle completion status

All endpoints will include:
- Request/response schemas
- Authentication requirements
- Error responses (400, 401, 404, 500)
- Validation rules

### 3. Quickstart Guide (`quickstart.md`)

Developer setup instructions including:

- Prerequisites (Docker, Docker Compose, Node.js, Python)
- Neon PostgreSQL database setup
- Environment variable configuration
- Running the application (`docker-compose up`)
- Accessing the application (URLs)
- Running tests
- Troubleshooting common issues

## Phase 2: Implementation Phases

*Note: Task generation happens via `/sp.tasks` command, not `/sp.plan`*

Implementation will follow these phases as defined in user input:

1. **Repository & Spec-Kit Setup**: Monorepo structure, Claude Code instructions
2. **Backend Foundation (FastAPI)**: Application scaffold, config, health check
3. **Database & Persistence Layer**: SQLModel models, Neon connection, migrations
4. **Authentication & Authorization**: Better Auth integration, JWT middleware
5. **API Implementation**: All REST endpoints with validation and error handling
6. **Frontend Application**: Next.js UI, authentication flow, API integration
7. **Dockerization & Local Orchestration**: Dockerfiles, docker-compose.yml
8. **End-to-End Validation**: Multi-user testing, security verification

## Risk Management

### Identified Risks

| Risk | Impact | Likelihood | Mitigation Strategy |
|------|--------|------------|---------------------|
| JWT secret mismatch between frontend/backend | High | Medium | Use shared JWT_SECRET environment variable, validate on startup |
| User data exposure (incorrect filtering) | Critical | Medium | Mandatory user_id filtering in all queries, code review enforcement |
| Environment variable misconfiguration | High | Medium | Comprehensive .env.example, validation on startup |
| Docker networking issues | Medium | Low | Use explicit service names in docker-compose, health checks |
| Neon PostgreSQL connection failures | High | Low | Connection pooling, retry logic, clear error messages |
| Better Auth integration complexity | Medium | Medium | Follow official docs, test authentication flow early |
| Token expiration handling | Medium | Medium | Implement token refresh, clear error messages for expired tokens |

### Mitigation Strategies

1. **Shared Secrets**: Single `JWT_SECRET` environment variable used by both services
2. **Mandatory Ownership Checks**: Database queries filtered by `user_id` from JWT claims
3. **Centralized Configuration**: All environment variables loaded from single source
4. **Incremental Testing**: Validate each phase before proceeding to next
5. **Early Integration**: Test frontend-backend communication in Phase 4

## Completion Criteria

The implementation plan is considered successfully executed when:

1. ✅ All constitution compliance checks pass
2. ✅ All research tasks completed and documented in `research.md`
3. ✅ Data model designed and documented in `data-model.md`
4. ✅ API contracts generated in `contracts/api-spec.yaml`
5. ✅ Quickstart guide created in `quickstart.md`
6. ✅ Agent context updated with project technologies
7. ⏳ Tasks generated via `/sp.tasks` command (separate step)
8. ⏳ All implementation phases completed (tracked in tasks.md)

## Next Steps

1. **Immediate**: Execute Phase 0 research tasks
2. **After Research**: Generate Phase 1 design artifacts
3. **After Design**: Run `/sp.tasks` to generate implementation tasks
4. **After Tasks**: Begin implementation via `/sp.implement` or manual task execution

## Authority

This plan is binding under the authority of the **Project Constitution v2.0.0** and must be followed exactly during implementation. Any changes require an explicit update to this plan with documented rationale.
